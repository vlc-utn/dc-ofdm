%% Test OFDM Channel Estimator
% TODO: test with customized channel
% Besides, the channel should be all "ones", but is kinda noisy for some
% subcarriers.
clc; clear; close all;
addpath("../../src");
addpath("../../inc");
addpath("../../src/rx");
constants;

%% Inputs
delayBetweenOFDMSymbols = false(100, 1);
paramFile = "sampleParametersFile";
pBits = [];
OFDMTx = fullTx(CONST, paramFile, pBits, 0, false);
OFDMRx = downshifter(CONST, OFDMTx);
%OFDMRx = rxInterpolator(CONST, OFDMRx);
OFDMRx = rxDecimator(CONST, OFDMRx);
OFDMRx = OFDMRx(1+CONST.preambleOFDMSamples:end);

% Demodulate channel and header
channelRx = OFDMRx(1:CONST.channelOFDMSamples); 
headerRx = OFDMRx(1+CONST.channelOFDMSamples:end);

channelCarriers = ofdmdemod(channelRx, CONST.N, ...
    CONST.channelCyclicPrefixLen, 0, CONST.nullIdx);
headerCarriers = ofdmdemod(headerRx, CONST.N, ...
    CONST.headerCyclicPrefixLen, 0, CONST.nullIdx);

for i=1:1:width(channelCarriers)
    channelCarriers(:,i) = constellationScrambler( ...
        channelCarriers(:,i), CONST.channelScramblerInit, true);
end

for i=1:1:width(headerCarriers)
    headerCarriers(:,i) = constellationScrambler( ...
        headerCarriers(:,i), CONST.headerScramblerInit, true);
end
dataIn = [
    channelCarriers(:,1);
    delayBetweenOFDMSymbols;
    channelCarriers(:,2);
    delayBetweenOFDMSymbols;
    headerCarriers(:);
];

validDataIn = [
    false(length(channelCarriers(:)), 1);
    delayBetweenOFDMSymbols;
    delayBetweenOFDMSymbols;
    true(length(headerCarriers(:)), 1);
];

validChannelIn = [
    true(length(channelCarriers(:,1)), 1);
    delayBetweenOFDMSymbols;
    true(length(channelCarriers(:,2)), 1);
];

%% Expected Output
[OFDMHeader, channelEst] = ofdmChannelEstimation(CONST, OFDMRx);
    
qamSignalScrambled = ofdmdemod(OFDMHeader, CONST.N, ...
    CONST.headerCyclicPrefixLen, 0, CONST.nullIdx);

qamSignal = zeros(size(qamSignalScrambled));
 for i=1:1:width(qamSignalScrambled)
    qamSignal = constellationScrambler(qamSignalScrambled(:,i), ...
        CONST.headerScramblerInit, true);
    qamSignal = ofdmChannelEqualizer(qamSignal, channelEst);
 end

 expectedChannelEst = channelEst;
 expectedOut = qamSignal;

%% Simulation Time
latency = 300/CONST.fPHY;
stopTime = (length(dataIn)-1)/CONST.fPHY + latency;

%% Run the simulation
model_name = "HDLChannelEstimator";

load_system(model_name);
simOut = sim(model_name);

dataOut = get(simOut, "dataOut");
startOut = get(simOut, "startOut");
endOut = get(simOut, "endOut");
validOut = get(simOut, "validOut");
channelEstOut = get(simOut, "channelEstOut");

%% Compare with MATLAB reference algorithm
startIdx = find(startOut == true);
endIdx = find(endOut == true);

assert(isequal(length(startIdx), length(endIdx)));

% Channel estimation test
out = channelEstOut(startIdx(1):endIdx(1));
assert(iskindaequal(expectedChannelEst, out, 10e-3));

% Equalized output test
for i=1:length(startIdx)
    out = dataOut(startIdx(i):endIdx(i));
    assert(iskindaequal(expectedOut, out, 10e-3));
end

disp("Test Successful!");

%% Last channel estimation
% 1.03009457440003 - 0.0722327532849883i
% 1.02552192687355 - 0.0683997686525859i
% 1.02928830737676 - 0.0654768459684124i
% 1.06648044805696 + 0.0314952627838209i
% 1.03702951976909 - 0.0621091938116842i
% 1.06546599994495 + 0.0312818392182707i
% 1.03131115430526 - 0.0604427238851237i
% 1.05614980249721 + 0.0302896202876329i
% 1.05329140204041 + 0.0297622891901963i
% 0.937347089176177 - 0.0293817041950918i
% 1.05578376981894 + 0.0291868058056641i
% 1.05901133032324 + 0.0291257413955507i
% 0.975612773940827 + 0.0564244803947434i
% 1.06090781704799 + 0.0289195858821353i
% 0.973436479655880 + 0.0564830371603723i
% 0.970556097233011 + 0.0565805308464373i
% 0.968812073346660 + 0.0565496546484632i
% 0.969486098118842 + 0.846289588651473i
% 1.02334956420469 + 0.718190340638372i
% 1.05682097494426 - 0.733519304533012i
% 1.72147948466610 + 0.0546376302589355i
% 1.70345429650849 + 0.0540512675581401i
% 1.02711999275935 + 0.647130409096287i
% 0.345334697723110 - 0.0532863570458209i
% 1.59883242098248 - 0.0233075302504027i
% 1.57547927649769 - 0.0230499894749517i
% 0.361768434308061 + 0.0530887455269030i
% 1.05312297323208 - 0.569602044010048i
% 0.950307244935299 - 0.592803064124945i
% 0.434598732351843 + 0.0531033890800909i
% 0.497130934241562 - 0.0529297279396030i
% 1.05325229698737 + 0.522385783819119i
% 0.944899979436692 - 0.497708980486852i
% 1.39970573125084 - 0.0175415745225339i
% 0.611255421908496 + 0.0171167680758582i
% 1.39403411810677 + 0.0492450446551253i
% 0.984740014793413 + 0.440932544289668i
% 0.986892476581132 + 0.420219121900804i
% 1.05267264723269 - 0.333423114747133i
% 1.38103691224695 + 0.0182233364087539i
% 0.979746382881089 - 0.260739256694629i
% 0.722033953374237 - 0.0498382452588562i
% 1.04450389748830 - 0.254532651654579i
% 1.01163903675114 + 0.202456110019981i
% 0.779131000355660 - 0.0492914637410131i
% 0.736838609956304 - 0.0124662176606519i
% 1.19708370020964 + 0.0473457752942723i
% 1.01467158505177 + 0.142007129088835i
% 0.953797316855274 + 0.162140969115292i
% 0.792204106399842 - 0.0110674011503357i
% 1.00546821472711 - 0.189008782446005i
% 0.985750405078405 + 0.175339175410902i
% 1.10975481208686 + 0.0427987225887391i
% 0.993641363481394 + 0.151422618918386i
% 0.895707336284679 + 0.0415021833888318i
% 0.955401313596970 + 0.0108517250724961i
% 1.12375922824944 + 0.0109471710732196i
% 0.986371384974956 + 0.113860294039068i
% 1.04910634360901 + 0.0408261353299664i
% 0.955166813312177 + 0.0469507526715368i
% 0.959033804892478 + 0.0407246124298605i
% 1.05608677618753 - 0.0391546075328112i
% 0.974857110085036 - 0.0382443943218174i
% 0.967977032121708 - 0.0439023562172269i
% 1.01123318633624 - 0.0680093074844182i
% 0.980080604632979 - 0.0364246842318848i
% 1.02693580656003 - 0.0361425126406908i
% 1.01137410274109 + 0.00869235273118297i
% 0.989697856915530 - 0.0351966352947387i
% 0.966756172320824 - 0.0213501574717740i
% 1.01249898826807 - 0.0216882896189108i
% 1.03764298690583 + 0.0188767202768198i
% 1.03479008558160 - 0.000337529896450845i
% 1.02253982956156 + 0.00963259215423980i
% 1.00552555681060 - 0.0250712395882781i
% 0.999839065870144 - 0.0312669768641612i
% 0.985396207547753 + 0.0282783300265102i
% 0.970511060884705 - 0.00980173911710341i
% 0.993506979401121 + 0.0321487058272983i
% 0.997609181341995 + 0.0293108110333156i
% 1.01200538449841 - 0.0285416250542255i
% 0.991900768037299 + 0.0280746076120256i
% 0.967394891223818 - 0.0116523329284114i
% 1.00681472889202 - 0.0282873176190001i
% 1.00697310890544 - 0.0283009049638357i
% 1.02684612205890 + 0.0124817571403368i
% 1.01317505403499 - 0.0288240939592887i
% 0.994303668306203 + 0.0279335429376389i
% 1.01594787893657 - 0.0284973943252091i
% 1.02853636925918 + 0.0106096328105020i
% 0.973385811647919 - 0.0109505773862028i
% 0.983976811681820 + 0.0255503246345939i
% 0.969495254885224 - 0.0109843628631073i
% 0.984036316678893 + 0.0251653759537871i
% 1.01303533236548 - 0.0244147533676842i
% 1.02925858998642 + 0.0122441010808208i
% 1.01823635097238 - 0.0249184024125109i
% 1.01691307973953 - 0.0245735046903505i
% 0.977528959720223 - 0.0122534918185666i
% 0.983594504967628 + 0.0231573574759719i
% 1.01779595897359 + 0.0127530572445795i
% 0.981224252379007 + 0.0229234389260062i
% 0.976454866434463 - 0.0129023944822024i
% 1.02545487408929 + 0.0132377073113592i
% 1.01900570865081 - 0.0207892953383455i
% 0.984453900402194 - 0.0127836755669933i
% 0.981403809651629 - 0.0145024531263824i
% 1.01749092258552 + 0.0154959839362531i
% 1.01465746526277 + 0.0172269850870940i
% 0.974148247298192 - 0.0162156010118430i
% 0.975312493256547 - 0.0174258111305755i
% 0.979426825230077 - 0.0171662429031855i
% 0.988470101232242 + 0.0218250840175229i
% 0.983646494364784 - 0.0149390979078358i
% 1.01787714718408 - 0.0207764290134113i
% 0.979319296486199 - 0.0154846401248128i
% 1.01133303768908 - 0.0181844272407815i
% 1.01311778881087 + 0.0166757958156446i
% 0.977495719278451 - 0.0168683436235726i
% 0.980775229731408 + 0.0179670560111527i
% 0.983492764815424 + 0.0182350679917616i
% 0.985978219493360 + 0.0194905828560348i
% 0.985761042683653 + 0.0186887954086968i
% 1.01975448847687 + 0.0192965107756966i
% 1.01493039583048 + 0.0193491914233768i
% 1.01399773369761 - 0.0173878695369441i
% 0.975092148844591 + 0.0189186008949348i
% 0.979744110971503 - 0.0200421094395851i
% 0.983425231056963 - 0.0203442416553631i
% 0.984569127510818 + 0.0189947642385338i
% 1.02369033713435 + 0.0215828184551432i
% 0.982210905230908 + 0.0180133154902069i
% 1.02024851638466 - 0.0175925404688403i
% 0.973753049128524 + 0.0182284851660569i
% 1.01586518446481 - 0.0190031968084150i
% 1.01496774455993 + 0.0210578300772105i
% 0.979977367120321 + 0.0184842264266987i
% 0.986931209107445 - 0.0216254877464095i
% 0.988984896642383 - 0.0214657961835866i
% 1.02547720015157 - 0.0163955731287111i
% 0.984881381577264 - 0.0205892263347582i
% 0.974495611009457 + 0.0157252130377345i
% 1.01677300952994 - 0.0146800720997483i
% 0.973060178783575 + 0.0153338361940945i
% 1.01458116428867 + 0.0225720059286260i
% 1.01676868535395 + 0.0227557735076509i
% 0.990827800853063 - 0.0239031906190697i
% 1.01921058449138 + 0.0229105044498153i
% 1.02570787802473 - 0.0135933284170608i
% 0.973287588598729 + 0.0138264159601136i
% 0.981687118233242 - 0.0251517430787279i
% 1.02109319789587 - 0.0132440044144036i
% 0.981768066358508 - 0.0271111187852717i
% 0.975280496840021 + 0.0141512210707346i
% 0.974088938105311 + 0.0146196257675823i
% 0.979669932574748 + 0.0149174844337486i
% 0.988133887567322 - 0.0255748140381442i
% 1.01620506161622 + 0.0275241854285020i
% 1.01011156356640 + 0.0246957611690796i
% 0.961756026255054 + 0.0143665999409197i
% 1.00958001345127 + 0.0343026136862276i
% 1.00524342314698 + 0.0285089557452740i
% 0.974272941535261 + 0.00450950669474019i
% 1.03452549765667 - 0.00320200010162688i
% 1.01793285554969 + 0.0413495170654057i
% 1.03136702677925 - 0.0266432669672963i
% 0.950440134832205 + 0.0133307976826990i
% 0.989085664851253 + 0.0316143381799897i
% 1.05018345891930 - 0.0138558508128051i
% 0.938486781373969 + 0.0143358143662856i
% 0.987570871121708 - 0.0639032713434873i
% 1.03802350238901 - 0.0502858477244673i
% 0.933753157652429 + 0.0150624059587687i
% 1.07977095089943 - 0.0148052073696319i
% 0.966263097791945 + 0.0644010230637742i
% 0.962428407325843 + 0.0709230796171231i
% 1.02555336418320 + 0.0140435635412895i
% 0.982931898353831 + 0.0382813424122102i
% 1.06812787083078 - 0.0351294271131296i
% 0.929365344860776 + 0.0352813154848987i
% 0.941567417862070 - 0.0152536314566085i
% 0.989113576256463 + 0.0742382409192289i
% 1.08503142176030 + 0.0145086688797690i
% 0.982565337414472 + 0.0959720163619632i
% 0.981260616753367 - 0.181754267248828i
% 0.823740178763672 - 0.0383638563743348i
% 0.959541270046101 + 0.187246379901061i
% 1.01811460940636 + 0.229316052726944i
% 1.16736092358016 + 0.0161841679600678i
% 0.767839305847596 - 0.0416373552719248i
% 0.724303611176318 + 0.0182165745179826i
% 1.01560941532337 + 0.293467977061193i
% 0.953375094506638 - 0.251753667843402i
% 0.663599652663074 + 0.0188280837627602i
% 1.01676399003727 - 0.268198786539666i
% 1.31266152358752 - 0.0423767934160774i
% 0.961740842316648 - 0.330902124554587i
% 0.982984960729584 + 0.329394370216523i
% 0.979570534470181 + 0.350143612066985i
% 1.36939432408052 + 0.0229461315562165i
% 0.584135663273097 + 0.0411274638118719i
% 1.47377831002006 + 0.0408199226221052i
% 1.03769478302136 - 0.502214087449656i
% 1.04177173340079 + 0.480541878248279i
% 0.435705443528845 + 0.0229596260230261i
% 0.497088862638152 - 0.0234050302451226i
% 1.04509671568445 - 0.595140964693039i
% 0.958538563616345 - 0.567406051011568i
% 0.425630511697355 - 0.0247128030906880i
% 1.65342427670865 + 0.0409119985025242i
% 1.67690937994486 + 0.0407403890335487i
% 0.281194070383925 + 0.0250472072889818i
% 1.02868691666351 + 0.741299807723591i
% 1.68686006863597 + 0.0254176752583037i
% 1.70545416975368 + 0.0255966810658594i
% 0.961667097867492 - 0.732525838943850i
% 1.02357338397861 + 0.813629067613109i
% 0.970279074102493 + 0.750623169607163i